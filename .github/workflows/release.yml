name: Create Release from Tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract changelog entry for tag
        env:
          TAG: ${{ github.ref_name }}
        run: |
          # Extract the changelog section for the tag into a file.
          # Assumes CHANGELOG.md uses headings like "## v1.2.3 - YYYY-MM-DD".
          awk -v tag="## ${TAG}" '
            $0 == tag { capture = 1; next }
            /^## v[0-9]/ && capture { exit }
            capture { print }
          ' CHANGELOG.md > release_body_content.md || true

          # If nothing was captured, produce a minimal body.
          if [ ! -s release_body_content.md ]; then
            echo "No changelog entry found for ${TAG}" > release_body_content.md
          fi

          # Prefix with a header with the tag
          {
            echo "${TAG}";
            echo "";
            cat release_body_content.md;
          } > release_body.md
      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          bodyFile: release_body.md
          draft: false
          prerelease: false
